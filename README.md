# Environmental DNA Reveals Reykjavík’s Human and Ecological History – Microbial Fraction Analyses

This repository contains the R scripts and associated workflow used for the analysis of the microbial fraction of sedimentary environmental DNA (sedaDNA) from Lake Tjörnin (Reykjavík, Iceland), as presented in the preprint *Environmental DNA Reveals Reykjavík’s Human and Ecological History*, doi: https://doi.org/10.1101/2025.10.08.681091.


These analyses form part of the multi-proxy study reconstructing human and ecological history over the past ~1400 years from a sediment core recovered in central Reykjavík. The microbial component provides insights into ecosystem functioning, anthropogenic impact, and nutrient cycling throughout major cultural and climatic transitions.


## Overview

The microbial sedaDNA analyses focus on:
- Integrating taxonomic profiling data with post-mortem DNA damage estimates.
- Assessing microbial community composition, richness, and turnover through time.
- Evaluating potential microbial sources (host-associated, environmental, and anthropogenic) using SourceTracker2 and complementary source-tracking approaches.
- Performing functional profiling to infer ecological and metabolic potential of the microbial assemblages.


## Repository Structure

<pre lang="markdown">
├── scripts/
│   ├── 01_taxonomic_integration_and_damage_filtering.R
│   │   └─ Integrates microbial taxonomic assignments and post-mortem DNA damage patterns.
│   │
│   ├── 02_alpha_and_beta_diversity.R
│   │   └─ Calculates within-sample (α) and between-sample (β) diversity, NMDS, Indval, etc.
│   │
│   ├── 03_sourcetracker_data_preparation.R
│   │   └─ Prepares filtered microbial datasets and metadata for SourceTracker2 source–sink modelling.
│	│
│   ├── 03_sourcetracker_execute.R
│   │   └─ Bash script executing Sourcetracker2 over previously generated files.
│   │
│   ├── 04_host_and_environmental_sources_analysis.R
│   │   └─ Integrate SourceTracker results with additional source-tracking approaches.
│   │
│   └── 05_functional_profiling.R
│       └─ Annotates microbial taxa functionally and summarizes temporal shifts in ecological functions.
│
│
├── data/
│   ├── filterbam/
│   │   └─ References mapping statistics from filterBAM.
│   │
│   ├── metadmg/
│   │   └─ LCA and damage estimates.
│   │
│   ├── sourcetracker/
│   │   └─ Data from potential sources used to explore their potential contribution into sink samples.
│   │
│   └── Additional input files including: metadata, references' functional annotation, isolation source for selected reference, etc.
│
│
├── plots/
│   └─ Output figures generated by the workflow.
│
│
└── results/
│    └─ Output and intermediate files generated by the scripts (e.g., filtered tables, Sourcetracker results).
│
│
└── libs/
     └─ Additional functions.

</pre>




## Microbial taxonomic profiling and damage assessment.

This script (```01_taxonomic_integration_and_damage_filtering.R```) combines filterBAM outputs with post-mortem damage estimates from metaDMG, computing Lin’s concordance correlation coefficient (CCC) to evaluate the fit between observed and expected nucleotide misincorporation patterns. Taxa are classified as “Damaged” or “Non-damaged” based on damage parameters, providing a robust filter for distinguishing authentic ancient DNA signals from potential modern contaminants.

The resulting abundance tables integrate taxonomic, abundance, and damage information at both subspecies and species levels, and are stored as phyloseq objects for downstream community analyses.
These outputs form the analytical basis for the ordination, source attribution, and functional profiling scripts (02–05).

## Alpha– and beta- diversity, clustering and Indicator species analysis.

This script (```02_alpha_and_beta_diversity.R```) quantifies within-sample (α) and between-sample (β) microbial diversity through time. It performs exploratory analyses of sequencing depth and richness, filters potential modern taxa based on DNA damage and occurrence patterns, and computes standard α-diversity indices (Observed, Shannon, Simpson). Community composition is evaluated using Bray–Curtis dissimilarity followed by non-metric multidimensional scaling (NMDS) and hierarchical clustering (Ward’s method).
The optimal number of clusters is determined by maximizing the average silhouette width, and indicator species analysis (IndVal.g) identifies taxa significantly associated with each cluster (p < 0.01, stat > 0.5).

Outputs include summary plots of richness and domain abundance, NMDS ordinations, and cluster-level indicator taxa visualizations.


## Microbial source tracking

This scripts (```03_sourcetracker_data_preparation.R```, ```03_sourcetracker_execute.R``` and ```04_host_and_environmental_sources_analysis.R```
) investigate the potential origins of microbial taxa by integrating host-association metadata, viral isolation sources, and SourceTracker analyses of bacterial and archaeal communities.

The workflow combines subspecies-level taxonomic profiles with curated reference metadata to identify taxa associated with specific hosts (e.g., Homo sapiens, livestock) and environmental niches. Viral genomes are classified using IMG/VR ecosystem annotations, allowing the identification of engineered, terrestrial, and aquatic sources.

For bacterial and archaeal components, SourceTracker2 (Knights et al., 2011) analyses were performed using modern metagenomic reference datasets, processed with identical pipelines to the ancient data. Estimated proportions from SourceTracker are integrated with host and viral classifications to reconstruct changing environmental and host contributions through time.

Outputs summarize:
-	The temporal abundance of host-associated taxa.
-	The relative contribution of viral ecological sources (IMG/VR).
-	SourceTracker-inferred bacterial and archaeal biome proportions.


## Functional profiling
This script (```05_functional_profiling.R```) reconstructs and quantifies the functional potential of microbial communities involved in nitrogen and sulfur cycling throughout the Tjörnin sedimentary record.

Using KEGG-based functional annotations derived from reference genomes (via Anvi’o estimate-metabolism), the script identifies taxa contributing to key metabolic modules — including nitrification, denitrification, nitrogen fixation, assimilatory and dissimilatory nitrate reduction, and sulfur reduction and oxidation pathways.

The workflow loads KEGG completeness tables and taxonomic abundance data, constructs filtered phyloseq objects, and computes module-level temporal changes (log₂ fold change relative to the oldest samples).
Separate analyses are implemented for nitrogen and sulfur metabolism, with corresponding visualization of long-term trends and pathway-specific contributions.

Outputs include comparative plots of module abundance across time, providing insights into shifts in biogeochemical cycling associated with settlement, climatic transitions, and urbanization phases.